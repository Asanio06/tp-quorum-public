=== Gestion de la production de fromages

==== Préparatifs

Maintenant que tout le fonctionnel lié aux livraisons de lait est opérationnel,
nous allons nous concentrer sur la production de fromages.


==== Développement du smart-contract `DairyProduction`

Le smart-contract `DailyProduction` va permettre à une laiterie de fabriquer du
fromage à partir de plusieurs livraisons de lait, tout en gardant confidentielles
les données. La coopérative sera aussi informée de ces fromages.

NOTE: Développer un test unitaire de DairyProduction permettant de vérifier
  son bon fonctionnement avant de passer à la suite des exercices du
  chapitre. +
  Une fois développé mentionner son existence et la manière de le lancer.

[source,solidity,linenums]
.DairyProduction.sol
----
include::../contracts/DairyProduction.sol[tag=!implementation]
----
<1> Quantité de fromage produit à partir du lait
<2> Adresses des smart-contracts `MilkDelivery` qui servent à la fabrication
    du fromage
<3> Adresse de la laitie qui fabrique le fromage
<4> Adresse du smart-contract `AdressBook` précédemment déployé
<5> L'adresse du smart-contract qui exécute le code peut être obtenue
    par `address(this)`
<6> La vérification de conformité vis à vis du label AOP va se faire en
    vérifiant que chaque éleveur de chaque livraison est dans la zone
    géographique adéquate, en s'appuyant donc sur `AddressBook`


ifdef::backend-pdf[<<<]

==== Développement du back-end pour les fabrications de fromage

Comme pour les exercices précédents, il va vous falloir implémenter le
back-end pour qu'il puisse permettre d'effecteur les différentes actions
avec les fromages.

Un squelette du back-end est disponible dans le fichier
`api/Services/Cheeses.js`, dont voici un extrait :

[source,javascript,linenums]
.api/Services/Cheeses.js
----
include::../api/Services/Cheeses.js[tag=!implementation]
----
<1> *Pensez à changer cette valeur pour l'adapter à votre blockchain !*


===== Fabriquer des fromages

Le code de démarrage de cet exercice est disponible dans le repository Git. +
Récupérez ce code et installez les dépendances qui vont bien :

[source,shell]
----
git checkout exercice-04
npm install
----

Il va maintenant vous falloir implémenter la méthode `makeCheese()`.

*A vous de jouer maintenant !*

Pour fabriquer du fromage à partir de la livraison de lait que nous avions
faite précédemment, voici les étapes à suivre :

* Choisissez en haut à droite Laiterie Beaufort
* Cliquez sur le bouton "Fabriquer du fromage"
* Saisir par exemple une quantité de fromage de 50 et la seule livraison
  de lait proposée (celle de l'éleveur Hauteluce)
* Cliquez dans la popup sur le bouton "Fabriquer du lait"

WARNING: Ce formulaire ne vérifie pas que seuls des nombres entiers sont
  saisis. +
  Attention à ne pas saisir de chiffres non entiers !

Vous devriez avoir une saisie similaire à celle ci :

image::{chapter-img}/exercice-04-popup.png[align=center, title-align=center]

TIP: La popup de fabrication de fromage ne propose que des livraisons de
lait qui ont été acceptées par la laiterie et qui n'ont pas déjà été
utilisée pour fabriquer du fromage.

Au passage, vous pourrez remarquer (si votre code est bon) que les
livraisons impliquées dans la fabrication de fromage ont un statut qui
a changé pour indiquer que le lait a été utilisé.

===== Lister les fromages

Il ne nous reste plus, maintenant, qu'à implémenter la fonctionnalité
permettant de lister les fromages fabriqués.

A nouveau nous allons repartir d'une branche Git opérationnelle :
[source,shell]
----
git checkout exercice-05
npm install
----

Il va mainteanant falloir implémenter la méthode `getCheeses()`.
Cette méthode doit renvoyer en retour un `Array` de ce type de
structures :
[source,javascript]
----
{
    id: '0x1245678', // <1>
    block: 124, // <2>
    timestamp: , // <3>
    certified: false, // <4>
    deliveries: ['0x4567547', '0x988357'] <5>
}
----
<1> Adresse de l'instance du smart-contract `DairyProduction`
<2> Numéro du bloc dans lequel l'événement `CheeseProduced` a été émis
<3> La date de création du bloc
<4> La valeur de `DairyProduction.checkGeoBoundaries()`
<5> La liste des adresses des `MilkDeliveries` impliqués dans la
    fabrication de fromage.

*A vous de jouer maintenant !*

Sur le front-end, connecté en tant que Laiterie Beaufort, vous devriez
maintenant retrouver le fromage fabriqué précédemment et constater
qu'il est valide au niveau du label AOP.

Amusez-vous à fabriquer du fromage à partir d'une livraison Eleveur
Bastia vers la Laiterie Beaufort et d'une autre livraison Eleveur Parly
vers la Laiterie Beaufort.
Vu que l'Eleveur de Bastia n'est pas dans la zone géographique du label
AOP, votre fromage sera indiqué automatiquement comme non certifié !

===== Synthèse

*Bravo !!!*

Vous avez accompli au travers de tous ces exercices plein des choses :

* manipulation de transactions privées et donc blockchains privées
* implémentation de smart-contracts
* déclenchement de transactions modifiant l'état des smart-contracts
* consultation de données via des événéments émis par la blockchain.

Vous savez donc maintenant commment envoyer des données dans une blockchain
et aussi comment extraire des informations depuis cette dernière !
 