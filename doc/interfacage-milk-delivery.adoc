=== Gestion des livraisons de lait

==== Préparatifs

Le code de démarrage de cet exercice est disponible dans le repository Git. +
Récupérez ce code et installez les dépendances qui vont bien :

WARNING: Sauvegardez en dehors du répertoire du projet les fichiers
  `truffle-config.js` et `data/addressbook.json`. En effet ils sont spécicifiques
  à votre consortium créé dans Kaleido ! +
  Restaurez les après avoir récupéré le code de la nouvelle branche. +
  Cette étape sera à répéter à chaque fois que vous démarrerez un nouvel exercice
  à partir d'une nouvelle branche.

[source,shell]
----
git checkout exercice-02
npm install
----


==== Développement du smart-contract `MilkDelivery`

Le smart-contract `MilkDelivery` va permettre à un éleveur d'envoyer une livraison
de lait à une laiterie tout en gardant confidentielles les données. La coopérative
sera aussi informée de ces livraisons, avec une visibilité sur toutes les livraisons.

Contrairement à l'`AddressBook` développé précédemment cette fois ci nous n'aurons
pas qu'une seule instance du smart-contract mais autant qu'il y aura de livraisons
faites. En effet il serait sinon impossible de rendre confidentielle une livraison
par rapport à une autre.

Etant donné donc qu'il y aura plusieurs instances de ce smart-contract, il va nous
falloir mettre en oeuvre un moyen de trouver la liste de ces instances.
Une première solution triviale pourrait être d'ajouter un autre smart-contract
gardant trace de toutes ces livraisons, mais dans le cas présent nous allons mettre
en oeuvre une implémentation plus efficace basée sur l'écoute d'événements émis
par la blockchain.

Votre premier exercice dans ce chapitre va consister à implémenter intégralement le
smart-contract `MilkDelivery`. Vous retrouverez ci-dessous une explication du
squelette du code ainsi que des instructions sur le travail à faire.

[source,solidity,linenums]
.MilkDelivery.sol
----
include::../contracts/MilkDelivery.sol[tag=!implementation]
----
<1> Nombre de litres de lait envoyés par l'éleveur
<2> Prix facturé par l'éleveur à la laiterie
<3> Acceptation de la livraison par la laiterie
<4> Livraison déjà utilisée pour fabriquer du fromage
<5> Adresse Ethereum de l'éleveur
<6> Adresse Ethereum de la laiterie
<7> *Ces fonctionnalités sont donc à développer de votre côté !*

Vous pouvez compiler le code de vos smart-contracts en exécutant la commande
suivante : ```truffle compile```.

NOTE: Développer un test unitaire de MilkDelivery permettant de vérifier son bon
  fonctionnement avant de passer à la suite des exercices du chapitre. +
  Une fois développé mentionner son existence et la manière de le lancer.


ifdef::backend-pdf[<<<]

==== Développement du back-end pour les livraisons de lait

L'application web (front-end) fait des appels à une API REST implémentée par un 
back-end que vous allez progressivement développer.

Vous allez donc devoir commencer par implémenter le lien entre l'appel au back-end
et le déclenchement des actions souhaitées au niveau de Quorum.

Le fichier qui sera à compléter est `api/Services/MilkDeliveries.js`.

[source,javascript,linenums]
.api/Services/MilkDeliveries.js
----
include::../api/Services/MilkDeliveries.js[tag=!implementation]
----
<1> Import des *helpers* présent dans le dossier `api/Helpers`
<2> Import de la bibliothèque https://docs.ethers.io/ethers.js/html/[ethers.js]
qui est une version plus "moderne" de https://web3js.readthedocs.io/en/v1.2.1/[Web3.js]
<3> La constante `FILTER_FROM_BLOCK` est importante (pour plus tard) car elle
définit depuis quel bloc nous recherchons les événements `MilkDelivered`. Il faudra
la personnaliser pour votre propre Consortium.

===== Livrer du lait

Afin de vous aider un peu nous allons vous montrer comment est codée la fonction
`createMilkDelivery()`.

[source,javascript,linenums]
.createMilkDelivery()
----
include::../api/Services/MilkDeliveries.js[tag=createMilkDelivery]
----

Déroulons ensemble l'implémentation de cette méthode.

Tout d'abord nous allons avoir besoin de trouver l'adresse Ethereum de l'acteur
qui fait l'appel à l'API REST. L'API reçoit un libellé qui est le nom de l'acteur.
Si vous vous souvenez des chapitres précédents, nous avions créé un fichier json
qui contient une définition de pas mal d'informations sur tous les participants.
Ce qui nous intéresse est la propriété `user_account` qui contient l'adresse
Ethereum.
[source,javascript,indent=0]
----
include::../api/Services/MilkDeliveries.js[lines=101..103]
----

Ensuite nous allons devoir faire des appels aux smart-contracts `AddressBook`
et ```MilkDelivery```. Des méthodes utilitaires sont disponibles pour simplifier
cela. Pour information, ces méthodes utilitaires s'appuient sur la librairie
https://www.npmjs.com/package/@truffle/contract[truffle-contract] fréquemment
utilisée pour permettre de faire un appel à
une méthode d'un smart-contract comme si c'était une méthode JavaScript.
[source,javascript,indent=0]
----
include::../api/Services/MilkDeliveries.js[lines=105..107]
----

Nous allons maintenant avoir besoin de plusieurs adresses :

* L'adresse Ethereum de la laiterie
* L'adresse des transactions privées du noeud de la laiterie
* L'adresse des transactions privées du noeud de la coopérative

[source,javascript,indent=0]
----
include::../api/Services/MilkDeliveries.js[lines=109..112]
----

Il est maintenant temps de déployer une nouvelle instance du smart-contract
`MilkDelivery`. On précise bien dans le `privateFor` que l'on souhaite
inclure la laiterie et la coopérative.
[source,javascript,indent=0]
----
include::../api/Services/MilkDeliveries.js[lines=114..116]
----
WARNING: Avec Quorum il ne faut pas ajouter dans les `privateFor` le noeud
  qui déclenche la transaction. Il est implictement ajouté. Dans notre cas
  l'éleveur qui effectue la livraison est donc bien inclus puisque c'est
  lui qui fait l'appel à l'API !

Maintenant que le smart-contract est déployé, nous pouvons tout simplement
appeler la méthode `sendMilk()`, en n'oubliant pas de préciser à nouveau
dans le `privateFor` qui sont les destinataires de cette transaction.
[source,javascript,indent=0]
----
include::../api/Services/MilkDeliveries.js[lines=118..119]
----

Puisque nous disposons d'une méthode permettant de déclencher une livraison
de lait il est grand temps de lancer l'application !

Pour démarrer le back-end, via un terminal et depuis le dossier `api`,
lancez la commande `npm run start`.

Pour démarrer le front-end, via un autre terminal et depuis le dossier racine
du projet, lancez la commande `npm run start`.

Pour effectuer une livraison de lait de l'éleveur Hauteluce vers Laiterie
Beaufort, voici les étapes à suivre :

* Lancer un navigateur web et aller sur l'adresse http://localhost:8080
* Choisissez en haut à droite Eleveur Hauteluce
* Cliquez sur le bouton "Livrer du lait"
* Saisir par exemple une quantité de 1000L et un prix de 10
* Cliquez dans la popup sur le bouton "Livrer du lait"

WARNING: Ce formulaire ne vérifie pas que seuls des nombres entiers sont
  saisis. +
  Attention à ne pas saisir de chiffres non entiers !

Vous devriez avoir une saisie similaire à celle ci :

image::{chapter-img}/exercice-02-popup.png[align=center, title-align=center]


===== Lister les livraisons de lait

Bien que nous puissions effectuer des livraisons, il serait souhaitable que
l'on puisse consulter une liste des livraisons effectuées.

Une autre méthode est définie à cet effet dans le fichier, à savoir
`getMilkDeliveries()`. 

Comme évoqué plus tôt dans ce chapitre, vu que chaque instance de
`MilkDelivery` va par défaut avoir une adresse différente et que nous ne
gardons trace nulle part des instances déployées, nous allons nous appuyer
sur les événements `MilkDelivered`.

Le code particulièrement intéressant pour cela est le suivant :
[source,javascript,indent=0]
----
include::../api/Services/MilkDeliveries.js[lines=36..44]
----
Il permet de parcourir des blocs pour retrouver les événements émis et de
récupérer dans la variable `logs` un `Array` de structures.

NOTE: `fromBlock` indique depuis quel bloc de la blockchain nous souhaitons
  commencer à trouver les événements. +
  C'est donc à contextualiser par rapport à votre environnement Kaleido, en
  changeant la constante `FILTER_FROM_BLOCK` définie tout en haut du
  fichier ! +
  +
  `topics` permet d'indiquer que l'on n'est intéressé que par les événements
  `MilkDelivered`. C'est important car plus tard nous émettrons d'autres
  événements.

De base ces structures ne permettent pas un accès facile aux données passées
dans l'événement émis. Afin d'interpréter ce contenu, nous nous appuyons
sur une méthode permettant cela :
[source,javascript,indent=0]
----
include::../api/Services/MilkDeliveries.js[lines=46..68]
----

Malheureusement les logs ne contiennent pas toutes les informations que nous
devons renvoyer en retour de l'API REST. En effet, l'écran affiche en plus :

* la date à laquelle la livraison a été faite
* l'acceptation (ou pas encore) de la livraison par la laiterie
* l'usage déjà fait (ou pas) de cette livraison pour fabriquer du fromage

Pour obtenir la date de livraison, le plus simple serait de savoir à quelle
date a été _miné_ le bloc contenant l'événement émis. Vous avez déjà accès
au numéro de bloc concerné (cf illustration de code précédente).

Il faut donc trouver un mécanisme permettant de trouver cette date pour un
numéro de bloc précis.

TIP: Le _helper_ `Blockchain` devrait bien vous aider pour cela.

Pour obtenir la confirmation (ou non) de la livraison par la laiterie nous
devons faire un appel à la bonne instance de `MilkDelivery` et appeler la
méthode `checkDeliveryApproval()`.

Même chose pour l'information indiquant si le lait a déjà été utilisé pour
fabriquer du fromage, avec cette fois ci un appel à la méthode `consumed()`.

Pour que votre API soit opérationnelle, il vous faut enrichir chaque élément
du tableau `results` avec les propriétés suivantes : 

* `timestamp`, pour la date de _minage_ du bloc,
* `deliveryApproval` pour l'acceptation de la livraison par la laiterie,
* et enfin `consumed` pour indiquer si du fromage a déjà été fabriqué avec
  ce lait.

Si tout est correctement implémenté, vous devriez pouvoir afficher la
livraison effectuée précédemment entre l'éleveur Hauteluce et la Laiterie
Beaufort :

image::{chapter-img}/exercice-02-end-result.png[align=center, title-align=center]

TIP: N'oubliez pas les confidentialités de données : si vous vous
  _connectez_ à _Eleveur Parly_ vous ne verrez pas cette livraison !

*A vous de jouer maintenant !*


===== Confirmer les livraisons de lait

La prochaine étape va consister à permettre à la laiterie qui reçoit une
livraison de lait de confirmer sa réception.

Afin de partir sur des bases de code communes, vous allez partir d'une
nouvelle branche :

[source,shell]
----
git checkout exercice-03
npm install
----

Toujours dans le fichier `api/Services/MilkDeliveries.js` il va donc
falloir implémenter la méthode `validateMilkDelivery()`.

Vous deviez pouvoir vous en sortir seul en vous inspirant notamment de
l'implémentation de la méthode `createMilkDelivery()`.

*A vous de jouer maintenant !*

Maintenant que c'est fait, en tant que Laiterie Beaufort, cliquez sur
l'icône du camion (grise actuellement) pour confirmer la livraison.

Cette icône passera en vert pour indiquer que la livraison a été
confirmée.
